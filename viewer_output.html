<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Base vs Variant Viewer</title>
  <style>
    :root{
      --bg0:#0F1117;
      --bg1:#1A1F2E;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.60);
      --accent:#00D4FF;
      --accent2:#FF6B35;
      --accent3:#A78BFA;
      --accent4:#10B981;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --r: 20px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--txt);
      font: 16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-text-size-adjust: 100%;
      background:
        radial-gradient(1400px 900px at 15% -5%, rgba(0,212,255,.15), transparent 50%),
        radial-gradient(1000px 800px at 85% 10%, rgba(255,107,53,.12), transparent 55%),
        radial-gradient(900px 900px at 50% 120%, rgba(16,185,129,.08), transparent 60%),
        radial-gradient(800px 600px at 80% 80%, rgba(167,139,250,.10), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 18px 14px 28px;
      touch-action: manipulation;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    header{
      display:block;
      padding: 6px 4px;
    }
    .viewer-header{
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:12px;
      min-width: 0;
    }
    .viewer-header-text{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      min-width: 0;
      flex-wrap: wrap;
    }
    .viewer-header-actions{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .viewer-title{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .viewer-description{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      text-align:left;
      flex: 1 1 320px;
      min-width: 240px;
      max-width: 680px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(0,212,255,.12), rgba(16,185,129,.12));
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 24px rgba(0,0,0,.20);
      color: var(--muted);
      font-size: 12.5px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent4));
      box-shadow: 0 0 14px rgba(0,212,255,.40);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .compare{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      background: rgba(0,0,0,.2);
    }

    .viewerFrame{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 10;
      min-height: 220px;
      max-height: 560px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.24);
    }

    .imgLayer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      user-select:none;
      -webkit-user-drag:none;
    }

    .variant{
      filter: saturate(1.05) contrast(1.05);
    }

    .navBtn{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(10,16,30,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 34px rgba(0,0,0,.38);
      color: var(--txt);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .navBtn{ z-index: 5; }
    .labels{ z-index: 4; }
    .imgLayer{ z-index: 1; }
    .navBtn:hover{ background: rgba(10,16,30,.62); border-color: rgba(255,255,255,.28); }
    .navBtn:active{ transform: translateY(-50%) scale(.98); }
    .navBtn.left{ left: 10px; }
    .navBtn.right{ right: 10px; }
    .navBtn svg{ width:18px; height:18px; opacity:.92; }

    /* new blur overlay styles */
    .blur-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      backdrop-filter: blur(0);
      transition: backdrop-filter 8s ease-in;
      z-index: 9998;
    }
    #pageContent.is-blurred {
      /* target strength can be adjusted as needed */
      filter: blur(5px); /* moderate blur - obscures details but not harsh on eyes */
      pointer-events: none;
    }
    /* Fullscreen layer that centers content without transform */
    .payment-layer {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: none;
      place-items: center;
      background: rgba(0,0,0,.45);
    }
    .payment-layer.show {
      display: grid;
    }
    .payment-button-container {
      position: relative;
      top: auto;
      left: auto;
      transform: none !important;
      z-index: 10001;
      background: linear-gradient(135deg, rgba(26, 31, 46, 0.95), rgba(10, 17, 30, 0.98));
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      padding: 24px;
      border-radius: 20px;
      border: 2px solid rgba(0, 212, 255, 0.35);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 40px rgba(0, 212, 255, 0.15);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 16px;
      width: 420px;
      max-width: 90vw;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      animation: slideUp 0.3s ease;
      pointer-events: auto !important;
      touch-action: auto !important;
      box-sizing: border-box;
      scrollbar-gutter: stable;
      cursor: auto;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* Smooth scrollbar styling */
    .payment-button-container::-webkit-scrollbar {
      width: 6px;
    }
    .payment-button-container::-webkit-scrollbar-track {
      background: rgba(0, 212, 255, 0.05);
      border-radius: 3px;
    }
    .payment-button-container::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 3px;
    }
    .payment-button-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 212, 255, 0.5);
    }
    @keyframes slideUp {
      from { transform: translate(-50%, -45%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }
    .payment-button-container #paypal-button-container {
      min-width: 100%;
      max-width: 100%;
      pointer-events: auto !important;
      touch-action: auto !important;
      width: 100%;
      overflow: visible !important;
      z-index: 10002;
      flex-shrink: 0;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      min-height: 50px;
      display: block !important;
      cursor: pointer !important;
    }
    #paypal-button-container {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    #paypal-button-container * {
      pointer-events: auto !important;
      touch-action: auto !important;
      cursor: pointer !important;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #paypal-button-container iframe {
      pointer-events: auto !important;
      touch-action: auto !important;
      display: block !important;
      -webkit-user-select: none;
      user-select: none;
    }
    #paypal-button-container button {
      pointer-events: auto !important;
      touch-action: auto !important;
      cursor: pointer !important;
      display: block !important;
      -webkit-appearance: none;
      appearance: none;
    }
    #paypal-button-container .pp-button {
      pointer-events: auto !important;
      cursor: pointer !important;
      display: block !important;
    }
    #paypal-button-container [data-funding-source] {
      pointer-events: auto !important;
      touch-action: auto !important;
      cursor: pointer !important;
      display: block !important;
    }
    .payment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin: 0;
      padding: 0;
      flex-shrink: 0;
      margin-bottom: 8px;
    }
    .payment-header button {
      background: none;
      border: none;
      color: rgba(0,212,255,.6);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      transition: color 0.2s ease;
    }
    .payment-header button:hover {
      color: rgba(0,212,255,.95);
    }
    .payment-text {
      text-align: center;
      color: rgba(255,255,255,.9);
      width: 100%;
      overflow: visible;
      flex-shrink: 0;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .payment-text h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    .payment-text p {
      margin: 0;
      line-height: 1.6;
      color: rgba(255,255,255,.75);
      font-size: 13px;
    }

    @media (max-width: 600px) {
      .payment-header {
        margin-bottom: 4px;
      }
      .payment-header button {
        font-size: 20px;
        width: 32px;
        height: 32px;
      }
      .payment-button-container {
        padding: 16px 12px;
        gap: 12px;
        width: 100%;
        max-width: 340px;
        max-height: 80vh;
        pointer-events: auto !important;
        touch-action: auto !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box;
        scrollbar-gutter: stable;
        flex-direction: column;
        align-items: stretch;
      }
      .payment-text {
        flex-shrink: 0;
        margin-bottom: 4px;
      }
      .payment-text h2 {
        font-size: 16px;
        margin: 0 0 6px 0;
      }
      .payment-text p {
        font-size: 11px;
        line-height: 1.4;
        margin: 0;
      }
      .payment-button-container #paypal-button-container {
        max-width: 100%;
        width: 100%;
        min-width: 100%;
        pointer-events: auto !important;
        touch-action: auto !important;
        flex-shrink: 0;
        display: block !important;
        min-height: 55px;
        overflow: visible !important;
        margin: 0;
        padding: 0;
      }
      .payment-button-container #paypal-button-container > * {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        padding: 0 !important;
        pointer-events: auto !important;
      }
      .payment-button-container #paypal-button-container iframe {
        width: 100% !important;
        max-width: 100% !important;
        pointer-events: auto !important;
        touch-action: auto !important;
        display: block !important;
      }
      /* Ensure PayPal buttons can receive touch events */
      .payment-button-container button {
        pointer-events: auto !important;
        touch-action: auto !important;
      }
      .unlock-message {
        font-size: 12px;
        padding: 10px 14px;
      }
    }
    .unlock-message {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 10000;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent4), var(--accent));
      border-radius: 12px;
      border: 2px solid rgba(16,185,129,.5);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      display: none;
      box-shadow: 0 8px 24px rgba(16,185,129,.40);
    }
    .unlock-message.show {
      display: block;
      animation: pulse 0.5s ease;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Card payment button bounce animation - subtle */
    @keyframes cardBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    /* Apply subtle bounce to card payment button */
    #paypal-button-container [data-funding-source="card"] {
      animation: cardBounce 1.5s ease-in-out infinite !important;
    }

    /* zoom overlay styles */
    .zoom-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.90);
      z-index: 10001;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      touch-action: none;
    }
    .zoom-overlay.visible { display: flex; }
    .zoom-stage{
      width: min(90vw, 1300px);
      height: 85vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border-radius: 14px;
      touch-action: none;
      cursor: grab;
    }
    .zoom-content{
      width: min(90vw, 1300px);
      height: calc(85vh + 64px);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: 12px;
    }
    .zoom-viewport{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      touch-action: none;
    }
    .zoom-overlay img {
      max-width: 90vw;
      max-height: 85vh;
      width: auto;
      height: auto;
      object-fit: contain;
      transform-origin: center center;
      touch-action: none;
      user-select: none;
      will-change: transform;
    }
    .zoom-nav{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex: 0 0 auto;
    }
    .zoom-nav-btn{
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(10,16,30,.48);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      color: rgba(255,255,255,.95);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .zoom-nav-btn:hover{ background: rgba(10,16,30,.65); border-color: rgba(255,255,255,.34); }
    .zoom-nav-btn:active{ transform: scale(.97); }
    .zoom-nav-btn svg{ width:20px; height:20px; opacity:.95; }
    .zoom-share-hint{
      display:none;
      margin-top: 2px;
      color: rgba(255,255,255,.72);
      font-size: 12px;
      text-align:center;
      letter-spacing:.1px;
    }
    body.zoom-lock{
      overflow:hidden;
      touch-action:none;
    }
    .zoom-button {
      position: relative;
      z-index: 1;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border: 2px solid rgba(0,212,255,.5);
      border-radius: 14px;
      width: 60px;
      height: 60px;
      font-size: 28px;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 8px 28px rgba(0,212,255,.45), 0 0 20px rgba(255,107,53,.20);
    }
    .zoom-button:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 36px rgba(0,212,255,.60), 0 0 28px rgba(255,107,53,.30);
    }
    .zoom-button:active {
      transform: scale(0.95);
    }
    .zoom-close-button {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 10002;
      background: linear-gradient(135deg, var(--accent4), var(--accent));
      border: 2px solid rgba(16,185,129,.5);
      border-radius: 12px;
      color: #fff;
      font-size: 24px;
      padding: 12px 16px;
      cursor: pointer;
      min-width: 50px;
      min-height: 50px;
      display: grid;
      place-items: center;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: 0 8px 24px rgba(16,185,129,.40);
    }
    .zoom-close-button:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(16,185,129,.50);
    }
    .zoom-download-button {
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 10002;
      background: linear-gradient(135deg, var(--accent2), #FF8A50);
      border: 2px solid rgba(255,107,53,.6);
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      padding: 12px 18px;
      cursor: pointer;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 8px 24px rgba(255,107,53,.40);
    }
    .zoom-download-button:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(255,107,53,.50);
    }
    .download-all-button {
      padding: 14px 20px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(0,212,255,.20), rgba(255,107,53,.20));
      border: 2px solid rgba(0,212,255,.50);
      color: rgba(255,255,255,.95);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .download-all-button:hover {
      background: linear-gradient(135deg, rgba(0,212,255,.30), rgba(255,107,53,.30));
      border-color: rgba(0,212,255,.80);
      box-shadow: 0 8px 24px rgba(0,212,255,.30);
    }
    .download-all-button:disabled {
      opacity: .65;
      cursor: wait;
      box-shadow: none;
    }

    /* Premium action availability */
    #zoomBtn,
    #downloadAllBtn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #zoomBtn.is-available,
    #downloadAllBtn.is-available {
      opacity: 1;
      pointer-events: auto;
    }

    /* Modal backdrop to prevent interaction with page */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: transparent;
      z-index: 9999;
      display: none;
      pointer-events: none;
    }
    .modal-backdrop.show {
      display: block;
      pointer-events: none;
    }

    .labels{
      position:absolute;
      left: 12px;
      right: 12px;
      top: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .variantFrame .labels{
      right: auto;
      justify-content: flex-start;
    }
    .variant-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      margin-top: 10px;
      padding: 0 2px;
    }
    .variant-lock-overlay{
      position:absolute;
      inset:0;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(8,12,20,.45);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .variantFrame.locked .variant{
      filter: blur(8px) saturate(.7) brightness(.82);
      transform: scale(1.02);
    }
    .variantFrame.locked .variant-lock-overlay{
      opacity:1;
      pointer-events:auto;
    }
    .variant-lock-panel{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:14px 16px;
      border-radius:14px;
      background: rgba(10,16,30,.62);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 16px 36px rgba(0,0,0,.38);
    }
    .variant-lock-text{
      font-size:13px;
      color: rgba(255,255,255,.88);
      text-align:center;
    }
    .unlock-variant-btn{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,212,255,.45);
      background: linear-gradient(135deg, rgba(0,212,255,.24), rgba(255,107,53,.24));
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    .unlock-variant-btn:hover{
      border-color: rgba(0,212,255,.78);
      background: linear-gradient(135deg, rgba(0,212,255,.34), rgba(255,107,53,.30));
    }
    .unlock-variant-btn:active{ transform: scale(.98); }
    .tag{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size: 12px;
      color: rgba(255,255,255,.82);
    }

    .panel{
      padding: 14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .panelTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      color: rgba(255,255,255,.88);
    }

    .kbd{
      font-size: 12px;
      color: var(--muted);
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }

    .textBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      padding: 12px 12px;
      color: rgba(255,255,255,.86);
      overflow: visible;
      height: auto;
      max-height: none;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .textBox p{ margin:0; }
    .textBox .muted{ color: var(--muted); }

    .metaRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.78);
      font-size: 12px;
    }

    /* Rich formatting inside the text area */
    .rich h3{ margin: 10px 0 6px; font-size: 13px; color: rgba(255,255,255,.90); }
    .rich ul{ margin: 6px 0 0 18px; padding:0; }
    .rich li{ margin: 4px 0; color: rgba(255,255,255,.82); }
    .rich,
    .rich p,
    .rich li,
    .rich h3,
    .rich span {
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .rich .hr{
      margin: 10px 0;
      height:1px;
      background: rgba(255,255,255,.12);
    }
    .swatch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.82);
      font-size: 12px;
    }
    .swatch .box{
      width:14px;height:14px;border-radius:4px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 8px 16px rgba(0,0,0,.35);
      background: var(--c);
    }

    /* Carousel dots */
    .carousel-dots {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 14px 0;
      margin: 0;
      pointer-events: none;
    }
    .carousel-dots .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,.25);
      transition: all 0.3s ease;
      cursor: pointer;
      pointer-events: auto;
      border: 1px solid rgba(0,212,255,.2);
    }
    .carousel-dots .dot.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      width: 28px;
      border-radius: 5px;
      box-shadow: 0 0 16px rgba(0,212,255,.70), 0 0 8px rgba(255,107,53,.50);
      border-color: rgba(0,212,255,.9);
      transform: scale(1);
    }
    .carousel-dots .dot:hover {
      background: rgba(0,212,255,.6);
      transform: scale(1.15);
      box-shadow: 0 0 12px rgba(0,212,255,.50);
    }
    .carousel-dots .dot:active {
      transform: scale(0.95);
    }

    @media (min-width: 860px){
      .panelGrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .viewer-title{ font-size: 20px; }
      .viewerFrame{ aspect-ratio: 16/9; }
    }

    /* mobile-specific tweaks */
    @media (max-width: 859px){
      body { font-size: 17px; }
      .viewer-header{ gap: 10px; }
      .viewer-header-text{ gap: 10px 14px; }
      .viewer-header-actions{ justify-content: center; }
      .viewer-title{ font-size: 18px; }
      .viewer-description{
        flex: 1 1 260px;
        min-width: 220px;
        font-size: 14px;
      }
      .zoom-button {
        width: 52px;
        height: 52px;
        font-size: 24px;
      }
      .navBtn{ width: 54px; height: 54px; border-radius: 18px; }
      .navBtn svg{ width:24px; height:24px; }
      .compare{ padding: 10px; gap: 10px; }
      .viewerFrame{ min-height: 240px; }
      .tag { font-size: 14px; padding: 10px 12px; }
      /* allow panels to scroll naturally with inertia */
      .panelGrid .card {
        overflow: visible;
        height: auto;
        max-height: none;
        -webkit-overflow-scrolling: touch;
      }
      .textBox.rich {
        max-height: none;
        overflow: visible;
        height: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
  </style>
</head>

<body>
  <!-- full‚Äëscreen blur layer; starts clear then animates in -->
  <div id="blurOverlay" class="blur-overlay"></div>
  
  <!-- Modal backdrop -->
  <div class="modal-backdrop" id="modalBackdrop"></div>
  
  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AT99Mni9WIsd_2Pvo8_B02s_UOeyH_11EzMRyEShBg5eJOx0wGIAITsGw52a7ntpAohIxqTtGGNAv7I2&currency=USD&intent=capture"></script>
  <script src="https://unpkg.com/@panzoom/panzoom@4.6.0/dist/panzoom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- Payment button container -->
  <div class="payment-layer" id="paymentLayer">
    <div class="payment-button-container" id="paymentContainer">
      <div class="payment-header">
        <div></div>
        <h3 style="margin: 0; font-size: 14px; color: rgba(255,255,255,.7);">Payment</h3>
        <button type="button" id="cancelPaymentBtn" aria-label="Cancel payment" title="Cancel">‚úï</button>
      </div>
      <div class="payment-text">
        <h2>Your preview is ready üé®</h2>
        <p>Unlock your full color package, including all variants, paint references, and budget guidance.<br><br>One-time payment. Secure checkout.</p>
      </div>
      <div id="paypal-button-container"></div>
    </div>
  </div>
  
  <!-- Unlock success message -->
  <div class="unlock-message" id="unlockMessage">‚úì Unlocked!</div>

  <!-- fullscreen zoomable image overlay -->
  <div id="zoomOverlay" class="zoom-overlay" aria-hidden="true">
    <button id="zoomCloseBtn" class="zoom-close-button" aria-label="Close full screen view" type="button">‚úï</button>
    <button id="zoomDownloadBtn" class="zoom-download-button" aria-label="Download this image" type="button">‚¨á Download</button>
    <div class="zoom-content">
      <div class="zoom-stage" id="zoomStage">
        <div class="zoom-viewport" id="zoomViewport">
          <img id="zoomImg" alt="Expanded variant" />
        </div>
      </div>
      <div class="zoom-nav" aria-label="Image navigation controls">
        <button id="zoomPrevBtn" class="zoom-nav-btn" type="button" aria-label="Previous image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <button id="zoomNextBtn" class="zoom-nav-btn" type="button" aria-label="Next image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>
      <div class="zoom-share-hint" id="zoomShareHint">Use Share ‚Üí Save Image to Photos</div>
    </div>
  </div>

  <div id="pageContent">
  <div class="wrap">
    <header>
      <div class="viewer-header">
        <div class="viewer-header-text">
          <h1 class="viewer-title">Repaint Options Viewer</h1>
          <p class="viewer-description">Original room photo on top, selected repaint option below. Use arrows, dots, swipe, or keyboard to browse.</p>
        </div>
        <div class="viewer-header-actions">
          <button id="downloadAllBtn" class="download-all-button" aria-label="Download all images" type="button">Download all images</button>
          <div class="pill"><span class="dot"></span><span id="counter">1/10</span></div>
        </div>
      </div>
    </header>

    <section class="card compare" id="compareCard">
      <div class="viewerFrame baseFrame">
        <img class="imgLayer base" id="baseImg" alt="Original room photo" />
        <div class="labels">
          <div class="tag" id="baseLabel">Original</div>
        </div>
      </div>

      <div class="viewerFrame variantFrame" id="variantFrame">
        <img class="imgLayer variant" id="variantImg" alt="Selected repaint option" />

        <div class="labels">
          <div class="tag" id="variantLabel">Option 1</div>
        </div>

        <div class="variant-lock-overlay" id="variantLockOverlay" tabindex="0" role="button" aria-label="Unlock this repaint option" hidden>
          <div class="variant-lock-panel">
            <div class="variant-lock-text">This repaint option is locked</div>
            <button id="unlockVariantBtn" class="unlock-variant-btn" type="button">Unlock to view</button>
          </div>
        </div>

        <button class="navBtn left" id="prevBtn" aria-label="Previous repaint option" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>

        <button class="navBtn right" id="nextBtn" aria-label="Next repaint option" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
      <div class="variant-actions">
        <button id="zoomBtn" class="zoom-button" aria-label="View selected option full screen" type="button">üîç</button>
      </div>
    </section>

    <!-- Carousel dots - below image -->
    <div class="carousel-dots" id="carouselDots"></div>

    <section class="panelGrid">
      <section class="card panel">
        <div class="panelTitle">
          <h2>Your selected repaint option</h2>
          <div class="kbd">Updates as you browse</div>
        </div>
        <div class="textBox rich" id="variantBox">
          <div id="variantHtml"></div>
        </div>
        <div class="metaRow" id="variantMeta"></div>
      </section>

      <section class="card panel">
        <div class="panelTitle">
          <h2>Project overview & buying guidance</h2>
          <div class="kbd">Universal</div>
        </div>
        <div class="textBox rich" id="generalBox">
          <div id="generalHtml"></div>
        </div>
        <div class="metaRow" id="generalMeta"></div>
      </section>
    </section>
  </div>
  </div>

  <script>
    // ----------------------------------------------------------
    // Folder structure (recommended):
    //   visualisation/
    //     index.html
    //     room_base_1024.png
    //     01_single.jpg ... 10_creative.jpg
    // ----------------------------------------------------------

    const baseImageUrl = "./room_base_1024.png";

    // ‚úÖ Full data embedded (from your JSON)
    const repaintData = {
  "notes": "10 repaint options featuring distinct color choices and diverse professional design schemes for the displayed room.",
  "assumptions_us": {
    "wall_area_sqft": 430.0,
    "coats": 2,
    "coverage_sqft_per_gallon_per_coat": 350.0,
    "waste_factor": 1.12,
    "primer_needed": false,
    "primer_coats": 1,
    "primer_coverage_sqft_per_gallon_per_coat": 300.0,
    "currency": "USD",
    "paint_price_per_gallon": 42.0,
    "primer_price_per_gallon": 22.0,
    "supplies_flat_cost": 55.0,
    "labor_mode": "hourly",
    "labor_rate_per_hour": 35.0,
    "hours_for_prep": 3.5,
    "hours_per_coat": 2.5,
    "labor_rate_per_sqft": 0.85,
    "location_hint": "USA",
    "suggested_store_types": [
      "Sherwin-Williams store",
      "Benjamin Moore dealer",
      "Home Depot (Behr)",
      "Lowe's (Valspar)",
      "Local paint/hardware store"
    ]
  },
  "images": [
    {
      "index": 1,
      "type": "single",
      "image": "01_single.jpg",
      "colors": [
        {
          "name": "Soft Sage Green",
          "hex": "#8A9A5B",
          "role": "all_walls",
          "area_percent": 100,
          "why": "Introduces a soothing natural tone that contrasts effectively with the original beige."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Soft Sage Green",
            "hex": "#8A9A5B",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 2,
      "type": "single",
      "image": "02_single.jpg",
      "colors": [
        {
          "name": "Dusty Blue",
          "hex": "#5F7D95",
          "role": "all_walls",
          "area_percent": 100,
          "why": "Provides a cool, serene atmosphere that distinctly transforms the space for relaxation."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Dusty Blue",
            "hex": "#5F7D95",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 3,
      "type": "single",
      "image": "03_single.jpg",
      "colors": [
        {
          "name": "Warm Terracotta",
          "hex": "#B6593A",
          "role": "all_walls",
          "area_percent": 100,
          "why": "Offers a warmer, earthy tone that stands out distinctly from the current neutral beige."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Warm Terracotta",
            "hex": "#B6593A",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 4,
      "type": "single",
      "image": "04_single.jpg",
      "colors": [
        {
          "name": "Muted Lavender",
          "hex": "#86688B",
          "role": "all_walls",
          "area_percent": 100,
          "why": "Soft purple hue that adds subtle moodiness and gentle contrast."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Muted Lavender",
            "hex": "#86688B",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 5,
      "type": "single",
      "image": "05_single.jpg",
      "colors": [
        {
          "name": "Slate Gray",
          "hex": "#646E78",
          "role": "all_walls",
          "area_percent": 100,
          "why": "Bold gray shade delivering a sleek, contemporary look."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Slate Gray",
            "hex": "#646E78",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 6,
      "type": "single",
      "image": "06_single.jpg",
      "colors": [
        {
          "name": "Deep Olive",
          "hex": "#556B2F",
          "role": "all_walls",
          "area_percent": 100,
          "why": "Rich, dark green providing depth and a noticeable transformation."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Deep Olive",
            "hex": "#556B2F",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 7,
      "type": "single",
      "image": "07_single.jpg",
      "colors": [
        {
          "name": "Charcoal Slate",
          "hex": "#3E4650",
          "role": "all_walls",
          "area_percent": 100,
          "why": "A light yet defined blue-gray shade that brightens and refreshes the room. (Adjusted for clear contrast.)"
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Charcoal Slate",
            "hex": "#3E4650",
            "role": "all_walls",
            "area_percent": 100,
            "wall_area_sqft": 430.0,
            "paint_needed_gallons_estimate": 2.75,
            "purchase_recommendation": {
              "gallons": 3,
              "quarts": 0,
              "total_gallons": 3.0
            },
            "paint_cost_estimate": 126.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 8,
      "type": "pro_2to3",
      "image": "08_pro_2to3.jpg",
      "colors": [
        {
          "name": "Creamy White",
          "hex": "#F1E9D2",
          "role": "main",
          "area_percent": 70,
          "why": "Brightens the space with a warm, soft base that contrasts with the current walls."
        },
        {
          "name": "Sage Green",
          "hex": "#7A8860",
          "role": "accent",
          "area_percent": 30,
          "why": "Offers a natural, calming accent that adds richness and visual interest."
        }
      ],
      "layout": {
        "accent_wall": "wall behind the corner sofa"
      },
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Creamy White",
            "hex": "#F1E9D2",
            "role": "main",
            "area_percent": 70,
            "wall_area_sqft": 301.0,
            "paint_needed_gallons_estimate": 1.93,
            "purchase_recommendation": {
              "gallons": 2,
              "quarts": 0,
              "total_gallons": 2.0
            },
            "paint_cost_estimate": 84.0,
            "currency": "USD"
          },
          {
            "name": "Sage Green",
            "hex": "#7A8860",
            "role": "accent",
            "area_percent": 30,
            "wall_area_sqft": 129.0,
            "paint_needed_gallons_estimate": 0.83,
            "purchase_recommendation": {
              "gallons": 1,
              "quarts": 0,
              "total_gallons": 1.0
            },
            "paint_cost_estimate": 42.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.0,
          "paint_cost_total": 126.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 9,
      "type": "pro_2to3",
      "image": "09_pro_2to3.jpg",
      "colors": [
        {
          "name": "Charcoal Slate",
          "hex": "#3E4650",
          "role": "main",
          "area_percent": 65,
          "why": "Contemporary, neutral base distinctly different from warm beige. (Adjusted for clear contrast.)"
        },
        {
          "name": "Charcoal Slate",
          "hex": "#3E4650",
          "role": "accent",
          "area_percent": 20,
          "why": "Soft accent tone that adds warmth and gentle contrast. (Adjusted for clear contrast.)"
        },
        {
          "name": "Charcoal",
          "hex": "#3B3B3B",
          "role": "trim",
          "area_percent": 15,
          "why": "Bold trim color that anchors the color scheme."
        }
      ],
      "layout": {
        "accent_wall": "wall behind the corner sofa"
      },
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Charcoal Slate",
            "hex": "#3E4650",
            "role": "main",
            "area_percent": 65,
            "wall_area_sqft": 279.5,
            "paint_needed_gallons_estimate": 1.79,
            "purchase_recommendation": {
              "gallons": 2,
              "quarts": 0,
              "total_gallons": 2.0
            },
            "paint_cost_estimate": 84.0,
            "currency": "USD"
          },
          {
            "name": "Charcoal Slate",
            "hex": "#3E4650",
            "role": "accent",
            "area_percent": 20,
            "wall_area_sqft": 86.0,
            "paint_needed_gallons_estimate": 0.55,
            "purchase_recommendation": {
              "gallons": 0,
              "quarts": 3,
              "total_gallons": 0.75
            },
            "paint_cost_estimate": 31.5,
            "currency": "USD"
          },
          {
            "name": "Charcoal",
            "hex": "#3B3B3B",
            "role": "trim",
            "area_percent": 15,
            "wall_area_sqft": 64.5,
            "paint_needed_gallons_estimate": 0.41,
            "purchase_recommendation": {
              "gallons": 0,
              "quarts": 2,
              "total_gallons": 0.5
            },
            "paint_cost_estimate": 21.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.25,
          "paint_cost_total": 136.5,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 489.0,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    },
    {
      "index": 10,
      "type": "creative",
      "image": "10_creative.jpg",
      "colors": [
        {
          "name": "Charcoal Slate",
          "hex": "#3E4650",
          "role": "main",
          "area_percent": 40,
          "why": "Generous calming base color that refreshes the entire room. (Adjusted for clear contrast.)"
        },
        {
          "name": "Charcoal Slate",
          "hex": "#3E4650",
          "role": "secondary",
          "area_percent": 20,
          "why": "Balances warmth and contrast with a natural blue tone. (Adjusted for clear contrast.)"
        },
        {
          "name": "Terracotta",
          "hex": "#B55A42",
          "role": "accent",
          "area_percent": 15,
          "why": "Rich, earthy hue that energizes and adds visual depth."
        },
        {
          "name": "Muted Olive",
          "hex": "#7A8C56",
          "role": "accent",
          "area_percent": 10,
          "why": "Complementary organic shade that reinforces a natural feel."
        },
        {
          "name": "Creamy White",
          "hex": "#F0E8D0",
          "role": "trim",
          "area_percent": 15,
          "why": "Light trim color that brightens edges and harmonizes the palette."
        }
      ],
      "layout": {},
      "estimate_us": {
        "assumptions_used": {
          "wall_area_sqft": 430.0,
          "coats": 2,
          "coverage_sqft_per_gallon_per_coat": 350.0,
          "waste_factor": 1.12,
          "primer_needed": false,
          "currency": "USD",
          "paint_price_per_gallon": 42.0,
          "primer_price_per_gallon": 22.0,
          "supplies_flat_cost": 55.0,
          "labor_mode": "hourly"
        },
        "quantities_by_color": [
          {
            "name": "Charcoal Slate",
            "hex": "#3E4650",
            "role": "main",
            "area_percent": 40,
            "wall_area_sqft": 172.0,
            "paint_needed_gallons_estimate": 1.1,
            "purchase_recommendation": {
              "gallons": 1,
              "quarts": 1,
              "total_gallons": 1.25
            },
            "paint_cost_estimate": 52.5,
            "currency": "USD"
          },
          {
            "name": "Charcoal Slate",
            "hex": "#3E4650",
            "role": "secondary",
            "area_percent": 20,
            "wall_area_sqft": 86.0,
            "paint_needed_gallons_estimate": 0.55,
            "purchase_recommendation": {
              "gallons": 0,
              "quarts": 3,
              "total_gallons": 0.75
            },
            "paint_cost_estimate": 31.5,
            "currency": "USD"
          },
          {
            "name": "Terracotta",
            "hex": "#B55A42",
            "role": "accent",
            "area_percent": 15,
            "wall_area_sqft": 64.5,
            "paint_needed_gallons_estimate": 0.41,
            "purchase_recommendation": {
              "gallons": 0,
              "quarts": 2,
              "total_gallons": 0.5
            },
            "paint_cost_estimate": 21.0,
            "currency": "USD"
          },
          {
            "name": "Muted Olive",
            "hex": "#7A8C56",
            "role": "accent",
            "area_percent": 10,
            "wall_area_sqft": 43.0,
            "paint_needed_gallons_estimate": 0.28,
            "purchase_recommendation": {
              "gallons": 0,
              "quarts": 2,
              "total_gallons": 0.5
            },
            "paint_cost_estimate": 21.0,
            "currency": "USD"
          },
          {
            "name": "Creamy White",
            "hex": "#F0E8D0",
            "role": "trim",
            "area_percent": 15,
            "wall_area_sqft": 64.5,
            "paint_needed_gallons_estimate": 0.41,
            "purchase_recommendation": {
              "gallons": 0,
              "quarts": 2,
              "total_gallons": 0.5
            },
            "paint_cost_estimate": 21.0,
            "currency": "USD"
          }
        ],
        "totals": {
          "paint_total_purchase_gallons": 3.5,
          "paint_cost_total": 147.0,
          "primer_needed_gallons_estimate": 0.0,
          "primer_purchase_recommendation": {
            "gallons": 0,
            "quarts": 0,
            "total_gallons": 0.0
          },
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "labor_hours_estimate": 8.5,
          "total_estimated_cost": 499.5,
          "currency": "USD"
        },
        "time_estimate_simple": "2 days (prep + 2 coats + drying time between coats)"
      }
    }
  ],
  "store_equivalents": {
    "notes": "Color matches are approximate and may vary depending on lighting and finish sheen. Always test samples before finalizing your selection.",
    "brands_included": [
      "sherwin_williams",
      "benjamin_moore",
      "behr",
      "ppg",
      "valspar"
    ],
    "colors": [
      {
        "hex": "#8A9A5B",
        "original_name": "Soft Sage Green",
        "equivalents": {
          "sherwin_williams": {
            "name": "Sage Advice",
            "code": "SW 6175",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Sagey",
            "code": "2122-30",
            "closest_match": true
          },
          "behr": {
            "name": "Sage Green",
            "code": "N400-4",
            "closest_match": true
          },
          "ppg": {
            "name": "Soft Sage",
            "code": "PPG 1012-5",
            "closest_match": true
          },
          "valspar": {
            "name": "Mossy Trail",
            "code": "6003-7C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #8A9A5B.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#5F7D95",
        "original_name": "Dusty Blue",
        "equivalents": {
          "sherwin_williams": {
            "name": "Steel Wool",
            "code": "SW 2848",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Silver Lake",
            "code": "1584",
            "closest_match": true
          },
          "behr": {
            "name": "Dusty Blue",
            "code": "S480-5",
            "closest_match": true
          },
          "ppg": {
            "name": "Blue Haze",
            "code": "PPG 1164-5",
            "closest_match": true
          },
          "valspar": {
            "name": "Stormy Sky",
            "code": "5007-7C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #5F7D95.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#B6593A",
        "original_name": "Warm Terracotta",
        "equivalents": {
          "sherwin_williams": {
            "name": "Cavern Clay",
            "code": "SW 7701",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Terra Cotta Tile",
            "code": "2173-30",
            "closest_match": true
          },
          "behr": {
            "name": "Rustic Terracotta",
            "code": "SDB-5",
            "closest_match": true
          },
          "ppg": {
            "name": "Canyon Rose",
            "code": "PPG 1142-6",
            "closest_match": true
          },
          "valspar": {
            "name": "Terracotta Tile",
            "code": "4004-6C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #B6593A.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#86688B",
        "original_name": "Muted Lavender",
        "equivalents": {
          "sherwin_williams": {
            "name": "Amethyst Orchid",
            "code": "SW 6859",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Purple Sage",
            "code": "1475",
            "closest_match": true
          },
          "behr": {
            "name": "Lavender Mist",
            "code": "S470-6",
            "closest_match": true
          },
          "ppg": {
            "name": "Plum Blossom",
            "code": "PPG 1086-6",
            "closest_match": true
          },
          "valspar": {
            "name": "Lavender Tint",
            "code": "5023-7C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #86688B.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#646E78",
        "original_name": "Slate Gray",
        "equivalents": {
          "sherwin_williams": {
            "name": "Dovetail",
            "code": "SW 7018",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Kendall Charcoal",
            "code": "HC-166",
            "closest_match": true
          },
          "behr": {
            "name": "Slate Gray",
            "code": "N520-6",
            "closest_match": true
          },
          "ppg": {
            "name": "Stormy Weather",
            "code": "PPG 1009-6",
            "closest_match": true
          },
          "valspar": {
            "name": "Urban Slate",
            "code": "4005-6C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #646E78.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#556B2F",
        "original_name": "Deep Olive",
        "equivalents": {
          "sherwin_williams": {
            "name": "Olive Grove",
            "code": "SW 6202",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Harvest Moss",
            "code": "2143-20",
            "closest_match": true
          },
          "behr": {
            "name": "Deep Olive",
            "code": "S440-5",
            "closest_match": true
          },
          "ppg": {
            "name": "Dark Olive",
            "code": "PPG 1013-6",
            "closest_match": true
          },
          "valspar": {
            "name": "Forest Floor",
            "code": "6001-5C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #556B2F.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#3E4650",
        "original_name": "Charcoal Slate",
        "equivalents": {
          "sherwin_williams": {
            "name": "Iron Ore",
            "code": "SW 7069",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Wrought Iron",
            "code": "2124-10",
            "closest_match": true
          },
          "behr": {
            "name": "Charcoal Slate",
            "code": "N510-7",
            "closest_match": true
          },
          "ppg": {
            "name": "Dark Slate",
            "code": "PPG 1010-7",
            "closest_match": true
          },
          "valspar": {
            "name": "Storm Cloud",
            "code": "4006-7C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #3E4650.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#F1E9D2",
        "original_name": "Creamy White",
        "equivalents": {
          "sherwin_williams": {
            "name": "Alabaster",
            "code": "SW 7008",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "White Dove",
            "code": "OC-17",
            "closest_match": true
          },
          "behr": {
            "name": "Sweet Cream",
            "code": "12",
            "closest_match": true
          },
          "ppg": {
            "name": "Ivory Tick",
            "code": "PPG 1014-1",
            "closest_match": true
          },
          "valspar": {
            "name": "Vanilla Frost",
            "code": "7003-3C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #F1E9D2.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#7A8860",
        "original_name": "Sage Green",
        "equivalents": {
          "sherwin_williams": {
            "name": "Sage Green Light",
            "code": "SW 2856",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Saybrook Sage",
            "code": "HC-114",
            "closest_match": true
          },
          "behr": {
            "name": "Sage Leaf",
            "code": "N390-5",
            "closest_match": true
          },
          "ppg": {
            "name": "Prairie Sage",
            "code": "PPG 1007-5",
            "closest_match": true
          },
          "valspar": {
            "name": "Sagebrush",
            "code": "6004-5C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #7A8860.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#3B3B3B",
        "original_name": "Charcoal",
        "equivalents": {
          "sherwin_williams": {
            "name": "Tricorn Black",
            "code": "SW 6258",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Kendall Charcoal",
            "code": "HC-166",
            "closest_match": true
          },
          "behr": {
            "name": "Charcoal",
            "code": "N510-5",
            "closest_match": true
          },
          "ppg": {
            "name": "Charcoal Gray",
            "code": "PPG 1008-7",
            "closest_match": true
          },
          "valspar": {
            "name": "Nightshade",
            "code": "4007-7C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #3B3B3B.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#B55A42",
        "original_name": "Terracotta",
        "equivalents": {
          "sherwin_williams": {
            "name": "Cavern Clay",
            "code": "SW 7701",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Pottery",
            "code": "2164-20",
            "closest_match": true
          },
          "behr": {
            "name": "Terracotta Red",
            "code": "SDB-6",
            "closest_match": true
          },
          "ppg": {
            "name": "Terracotta Tile",
            "code": "PPG 1143-6",
            "closest_match": true
          },
          "valspar": {
            "name": "Tuscan Clay",
            "code": "4005-6C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #B55A42.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#7A8C56",
        "original_name": "Muted Olive",
        "equivalents": {
          "sherwin_williams": {
            "name": "Mellow Moss",
            "code": "SW 6180",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Olive Grove",
            "code": "2145-30",
            "closest_match": true
          },
          "behr": {
            "name": "Olive Branch",
            "code": "N430-5",
            "closest_match": true
          },
          "ppg": {
            "name": "Olive Branch",
            "code": "PPG 1006-6",
            "closest_match": true
          },
          "valspar": {
            "name": "Olive Branch",
            "code": "6002-6C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #7A8C56.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      },
      {
        "hex": "#F0E8D0",
        "original_name": "Creamy White",
        "equivalents": {
          "sherwin_williams": {
            "name": "Eider White",
            "code": "SW 7014",
            "closest_match": true
          },
          "benjamin_moore": {
            "name": "Navajo White",
            "code": "OC-95",
            "closest_match": true
          },
          "behr": {
            "name": "Warm Cream",
            "code": "N340-2",
            "closest_match": true
          },
          "ppg": {
            "name": "Buttercream",
            "code": "PPG 1003-1",
            "closest_match": true
          },
          "valspar": {
            "name": "Creamy White",
            "code": "7010-2C",
            "closest_match": true
          }
        },
        "what_to_say_in_store": [
          "I would like the closest match to HEX #F0E8D0.",
          "I prefer an eggshell finish for washable interior walls.",
          "Please provide a sample or quart for testing first."
        ]
      }
    ],
    "how_to_get_best_match": [
      "Purchase a sample or quart first and apply on two walls for evaluation.",
      "Observe the color in both natural daylight and artificial lighting at night.",
      "Remember that finish sheen affects appearance: matte looks lighter, satin looks richer.",
      "If uncertain, compare paint with a physical swatch or printed sample rather than a phone screen."
    ]
  },
  "customer_value": {
    "global_notes": {
      "how_to_buy_exact_color": "Request a sample or quart for testing on your wall with your specific lighting prior to full purchase. Confirm the color match matches the provided HEX code at the store.",
      "multi_color_note": "Obtain samples or quarts of each color to test side-by-side on the walls. Clearly label each sample with its room location and color name to prevent confusion during application.",
      "disclaimer": "Color matches can slightly differ based on lighting and sheen, so always test samples before a large purchase."
    },
    "by_image": [
      {
        "index": 1,
        "recommended_paint_type": "washable interior acrylic/latex",
        "recommended_finish": "Eggshell finish is recommended for its subtle sheen, stain resistance, easy cleaning, and an elegant natural appearance suitable for interior walls.",
        "where_to_buy": {
          "store_types": [
            "Sherwin-Williams",
            "Benjamin Moore dealer",
            "Home Depot (Behr)",
            "Lowe's (Valspar)",
            "Local paint store"
          ],
          "what_to_ask_for": [
            "closest match to HEX #8A9A5B",
            "washable interior wall paint",
            "eggshell finish",
            "sample or quart first"
          ]
        },
        "exact_buy_list": {
          "per_color": [
            {
              "hex": "#8A9A5B",
              "name": "Soft Sage Green",
              "purchase": {
                "gallons": 3,
                "quarts": 0,
                "total_gallons": 3.0
              },
              "store_equivalents": {
                "sherwin_williams": "Sage Advice SW 6175",
                "benjamin_moore": "Sagey 2122-30",
                "behr": "Sage Green N400-4",
                "ppg": "Soft Sage PPG 1012-5",
                "valspar": "Mossy Trail 6003-7C"
              }
            }
          ],
          "primer": {
            "needed": false,
            "purchase": {
              "gallons": 0,
              "quarts": 0,
              "total_gallons": 0.0
            }
          },
          "supplies": [
            "tape",
            "plastic",
            "roller covers",
            "angled brush",
            "spackle",
            "sandpaper",
            "caulk"
          ]
        },
        "timeline": {
          "estimated_time": "2 days (prep + 2 coats + drying time between coats)",
          "prep_steps": [
            "Clear the room and cover floors with plastic sheets.",
            "Tape around trim, windows, and ceiling edges.",
            "Fill holes and cracks with spackle, then sand smooth.",
            "Lightly sand walls to improve paint adhesion."
          ],
          "paint_steps": [
            "Apply two even coats of eggshell finish paint.",
            "Allow the recommended drying time between coats.",
            "Carefully remove tape before final drying completes."
          ],
          "drying_notes": "Allow 2-4 hours drying between coats; full cure may take up to 7 days."
        },
        "cost_breakdown": {
          "paint_cost_total": 126.0,
          "primer_cost_total": 0.0,
          "supplies_cost_total": 55.0,
          "labor_cost_total": 297.5,
          "total_estimated_cost": 478.5,
          "currency": "USD"
        },
        "quality_tips": [
          "Use quality roller covers for smooth, even application.",
          "Maintain a 'wet edge' during painting to prevent lap marks.",
          "Stir paint thoroughly before and during use."
        ],
        "common_mistakes": [
          "Skipping surface prep, which can lead to peeling.",
          "Applying paint too thickly, causing drips.",
          "Not testing sample patches to verify color and sheen."
        ],
        "care_after_painting": [
          "Wait at least 2 weeks before washing painted walls.",
          "Use mild soap and soft cloth for cleaning to preserve finish.",
          "Avoid abrasive cleaners and harsh scrubbing."
        ]
      }
    ]
  }
};

    // Build variants list from data (so you only maintain JSON)
    const variants = repaintData.images.map(img => ({
      label: `Option ${img.index}`,
      imageUrl: `./${img.image}`,
      raw: img
    }));

    const baseImg = document.getElementById("baseImg");
    const variantImg = document.getElementById("variantImg");
    const compareCard = document.getElementById("compareCard");
    const variantFrame = document.getElementById("variantFrame");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const counter = document.getElementById("counter");
    const variantLabel = document.getElementById("variantLabel");

    const variantHtml = document.getElementById("variantHtml");
    const variantMeta = document.getElementById("variantMeta");
    const zoomBtnControl = document.getElementById("zoomBtn");
    const downloadAllBtnControl = document.getElementById("downloadAllBtn");
    const variantLockOverlay = document.getElementById("variantLockOverlay");
    const unlockVariantBtn = document.getElementById("unlockVariantBtn");

    const generalHtml = document.getElementById("generalHtml");
    const generalMeta = document.getElementById("generalMeta");

    const variantImageUrls = variants.map(v => v.imageUrl);
    const FREE_COUNT = 2;
    const TOTAL = variants.length;
    const UNLOCK_STORAGE_KEY = "repaint_unlocked";

    let idx = 0;
    let isPaid = false;
    let openPaymentModal = () => {};
    const preloadCache = new Map();

    try {
      isPaid = localStorage.getItem(UNLOCK_STORAGE_KEY) === "true";
    } catch (error) {
      isPaid = false;
    }

    function isLocked(index){
      return !isPaid && index >= FREE_COUNT;
    }

    function updateAccessUI(){
      const locked = isLocked(idx);
      variantFrame.classList.toggle("locked", locked);
      variantLockOverlay.hidden = !locked;

      zoomBtnControl.classList.toggle("is-available", !locked);
      downloadAllBtnControl.classList.toggle("is-available", isPaid);
    }

    function setPaidState(paid, { persist = true } = {}){
      isPaid = !!paid;
      if (persist) {
        try {
          localStorage.setItem(UNLOCK_STORAGE_KEY, isPaid ? "true" : "false");
        } catch (error) {
          // ignore localStorage failures
        }
      }
      updateAccessUI();
    }

    function esc(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function money(n, currency){
      const v = Number(n);
      if (Number.isNaN(v)) return esc(n);
      return `${currency || "USD"} ${v.toFixed(2)}`;
    }

    function gallonsText(p){
      // p = {gallons, quarts, total_gallons}
      if (!p) return "";
      const g = Number(p.gallons || 0);
      const q = Number(p.quarts || 0);
      const tg = Number(p.total_gallons || 0);
      const parts = [];
      if (g) parts.push(`${g} gallon${g===1?"":"s"}`);
      if (q) parts.push(`${q} quart${q===1?"":"s"}`);
      if (!parts.length) parts.push("0 gallons");
      return `${parts.join(" + ")} (total ${tg} gal)`;
    }

    function findEquivalentsByHex(hex){
      const item = (repaintData.store_equivalents?.colors || []).find(c => (c.hex || "").toLowerCase() === String(hex).toLowerCase());
      return item || null;
    }

    function swatchPill(hex, name){
      const safeHex = esc(hex);
      const safeName = esc(name || "");
      return `<span class="swatch" title="${safeName} ${safeHex}">
        <span class="box" style="--c:${safeHex}"></span>
        <span><b>${safeName}</b> ${safeHex}</span>
      </span>`;
    }

    function buildGeneral(){
      const a = repaintData.assumptions_us;
      const g = repaintData.customer_value?.global_notes || {};
      const se = repaintData.store_equivalents || {};

      const storeTypes = (a.suggested_store_types || []).map(x => `<li>${esc(x)}</li>`).join("");
      const matchTips = (se.how_to_get_best_match || []).map(x => `<li>${esc(x)}</li>`).join("");

      generalHtml.innerHTML = `
        <h3>Project summary</h3>
        <p class="muted">${esc(repaintData.notes)}</p>

        <div class="hr"></div>

        

        <div class="hr"></div>

        <h3>Where to buy (recommended store types)</h3>
        <ul>${storeTypes}</ul>

        <div class="hr"></div>

        <h3>How to buy the best match</h3>
        <p class="muted">${esc(se.notes || "")}</p>
        <ul>${matchTips}</ul>

        <div class="hr"></div>

        <h3>Client notes</h3>
        <ul>
          <li><b>How to buy exact color:</b> ${esc(g.how_to_buy_exact_color || "")}</li>
          <li><b>Multi-color note:</b> ${esc(g.multi_color_note || "")}</li>
          <li><b>Disclaimer:</b> ${esc(g.disclaimer || "")}</li>
        </ul>
      `; 

      generalMeta.innerHTML = ""; // intentionally empty (no chips in General panel)
    }

    function buildOptionHtml(img){
      const est = img.estimate_us;
      const totals = est?.totals || {};
      const currency = totals.currency || repaintData.assumptions_us.currency || "USD";

      // Per-image extra (only index 4 has the deep guidance in your data)
      const extra = (repaintData.customer_value?.by_image || []).find(x => x.index === img.index) || null;

      const layoutBits = [];
      if (img.layout && img.layout.accent_wall) layoutBits.push(`<li><b>Accent wall location:</b> ${esc(img.layout.accent_wall)}</li>`);

      const colorBlocks = (est?.quantities_by_color || []).map(q => {
        const eq = findEquivalentsByHex(q.hex);
        const equivLines = eq ? `
          <p style="margin-top: 8px; color: var(--muted); font-size: 14px;"><b>If that doesn't work, ask for:</b></p>
          <ol style="margin: 6px 0 0 18px; padding: 0;">
            <li><b>Sherwin-Williams:</b> ${esc(eq.equivalents.sherwin_williams.name)} (${esc(eq.equivalents.sherwin_williams.code)})</li>
            <li><b>Benjamin Moore:</b> ${esc(eq.equivalents.benjamin_moore.name)} (${esc(eq.equivalents.benjamin_moore.code)})</li>
            <li><b>Behr:</b> ${esc(eq.equivalents.behr.name)} (${esc(eq.equivalents.behr.code)})</li>
            <li><b>PPG:</b> ${esc(eq.equivalents.ppg.name)} (${esc(eq.equivalents.ppg.code)})</li>
            <li><b>Valspar:</b> ${esc(eq.equivalents.valspar.name)} (${esc(eq.equivalents.valspar.code)})</li>
          </ol>
        ` : `<p class="muted">No store-equivalent mapping found for ${esc(q.hex)}.</p>`;

        const why = (img.colors || []).find(c => c.hex.toLowerCase() === String(q.hex).toLowerCase() && c.role === q.role)?.why
                 || (img.colors || []).find(c => c.hex.toLowerCase() === String(q.hex).toLowerCase())?.why
                 || "";

        return `
          <div class="hr"></div>
          <h3>Color: ${esc(q.name)} (${esc(q.role)})</h3>
          <p>${swatchPill(q.hex, q.name)}</p>
          <h3>What to ask in store</h3>
          <ul>
            <li><b>Ask for HEX:</b> ${esc(q.hex)}</li>
          </ul>
          ${equivLines}
          <ul>
            <li><b>Area:</b> ${esc(q.area_percent)}% (~${esc(q.wall_area_sqft)} sq ft)</li>
            <li><b>Paint needed (estimate):</b> ${esc(q.paint_needed_gallons_estimate)} gallons</li>
            <li><b>Purchase recommendation:</b> ${esc(gallonsText(q.purchase_recommendation))}</li>
            <li><b>Paint cost (this color):</b> ${money(q.paint_cost_estimate, currency)}</li>
          </ul>
          <h3>Why this works</h3>
          <p class="muted">${esc(why)}</p>
        `;
      }).join("");

      const whatToSay = (() => {
        // If single color, use mapping from store_equivalents; otherwise show unique lines per unique hex.
        const uniqueHex = [...new Set((est?.quantities_by_color || []).map(x => x.hex.toUpperCase()))];
        const lines = uniqueHex.flatMap(h => {
          const eq = findEquivalentsByHex(h);
          return eq?.what_to_say_in_store || [];
        });
        // de-dup
        return [...new Set(lines)].map(x => `<li>${esc(x)}</li>`).join("");
      })();

      const suppliesList = extra?.exact_buy_list?.supplies
        ? extra.exact_buy_list.supplies.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const prepSteps = extra?.timeline?.prep_steps
        ? extra.timeline.prep_steps.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const paintSteps = extra?.timeline?.paint_steps
        ? extra.timeline.paint_steps.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const qualityTips = extra?.quality_tips
        ? extra.quality_tips.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const mistakes = extra?.common_mistakes
        ? extra.common_mistakes.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const care = extra?.care_after_painting
        ? extra.care_after_painting.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const whereBuyTypes = extra?.where_to_buy?.store_types
        ? extra.where_to_buy.store_types.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const whereBuyAsk = extra?.where_to_buy?.what_to_ask_for
        ? extra.where_to_buy.what_to_ask_for.map(x => `<li>${esc(x)}</li>`).join("")
        : "";

      const layoutSection = layoutBits.length ? `
        <h3>Layout notes</h3>
        <ul>${layoutBits.join("")}</ul>
      ` : "";

      const extraSection = extra ? `
        <div class="hr"></div>
        <h3>Recommended paint type & finish (Option ${img.index})</h3>
        <ul>
          <li><b>Paint type:</b> ${esc(extra.recommended_paint_type)}</li>
          <li><b>Finish:</b> ${esc(extra.recommended_finish)}</li>
        </ul>

        <h3>Where to buy</h3>
        <ul>${whereBuyTypes}</ul>

        <h3>What to ask for</h3>
        <ul>${whereBuyAsk}</ul>

        <h3>Exact buy list extras</h3>
        <ul>
          <li><b>Primer needed:</b> ${esc(extra.exact_buy_list.primer.needed)}</li>
          <li><b>Primer purchase:</b> ${esc(gallonsText(extra.exact_buy_list.primer.purchase))}</li>
        </ul>
        ${suppliesList ? `<h3>Supplies checklist</h3><ul>${suppliesList}</ul>` : ""}

        <h3>Timeline (detailed)</h3>
        <ul><li><b>Estimated time:</b> ${esc(extra.timeline.estimated_time)}</li></ul>
        ${prepSteps ? `<h3>Prep steps</h3><ul>${prepSteps}</ul>` : ""}
        ${paintSteps ? `<h3>Paint steps</h3><ul>${paintSteps}</ul>` : ""}
        <p class="muted"><b>Drying notes:</b> ${esc(extra.timeline.drying_notes)}</p>

        ${qualityTips ? `<h3>Quality tips</h3><ul>${qualityTips}</ul>` : ""}
        ${mistakes ? `<h3>Common mistakes</h3><ul>${mistakes}</ul>` : ""}
        ${care ? `<h3>Care after painting</h3><ul>${care}</ul>` : ""}
      ` : "";

      return `
        <p class="muted"><b>Type:</b> ${esc(img.type)} &nbsp; ‚Ä¢ &nbsp; <b>Image:</b> ${esc(img.image)}</p>
        ${layoutSection}

        <h3>What to say in store (works for this option)</h3>
        <ul>${whatToSay || "<li>Ask for the closest match to the HEX values shown for this option.</li>"}</ul>

        ${colorBlocks}

        <div class="hr"></div>

        <h3>Totals (Option ${img.index})</h3>
        <ul>
          <li><b>Paint purchase total:</b> ${esc(totals.paint_total_purchase_gallons)} gallons</li>
          <li><b>Paint cost total:</b> ${money(totals.paint_cost_total, currency)}</li>
          <li><b>Primer needed (estimate):</b> ${esc(totals.primer_needed_gallons_estimate)} gallons</li>
          <li><b>Primer purchase:</b> ${esc(gallonsText(totals.primer_purchase_recommendation))}</li>
          <li><b>Primer cost total:</b> ${money(totals.primer_cost_total, currency)}</li>
          <li><b>Supplies cost total:</b> ${money(totals.supplies_cost_total, currency)}</li>
          <li><b>Labor hours estimate:</b> ${esc(totals.labor_hours_estimate)} hours</li>
          <li><b>Labor cost total:</b> ${money(totals.labor_cost_total, currency)}</li>
          <li><b>Total estimated cost:</b> <b>${money(totals.total_estimated_cost, currency)}</b></li>
        </ul>

        <h3>Time estimate</h3>
        <p class="muted">${esc(est?.time_estimate_simple || "")}</p>

        ${extraSection}
      `;
    }

    function normalizeVariantIndex(index){
      const count = variants.length;
      if (!count) return 0;
      return ((index % count) + count) % count;
    }

    function preloadImage(url){
      if (!url || preloadCache.has(url)) return;
      const preloaded = new Image();
      preloaded.src = url;
      preloadCache.set(url, preloaded);
    }

    function preloadNeighborVariants(index){
      if (!variantImageUrls.length) return;
      const prevIndex = normalizeVariantIndex(index - 1);
      const nextIndex = normalizeVariantIndex(index + 1);
      preloadImage(variantImageUrls[prevIndex]);
      preloadImage(variantImageUrls[nextIndex]);
    }

    function setVariant(index){
      idx = normalizeVariantIndex(index);
      const v = variants[idx];
      const img = v.raw;

      baseImg.src = baseImageUrl;
      variantImg.src = v.imageUrl;

      variantLabel.textContent = v.label;
      counter.textContent = `${idx + 1}/${TOTAL}`;

      variantHtml.innerHTML = buildOptionHtml(img);

      // Meta chips (quick glance)
      variantMeta.innerHTML = "";
      const totals = img.estimate_us?.totals || {};
      const currency = totals.currency || repaintData.assumptions_us.currency || "USD";
      const chips = [
        `Type: ${img.type}`,
        `Paint: ${totals.paint_total_purchase_gallons} gal`,
        `Supplies: ${money(totals.supplies_cost_total, currency)}`,
        `Labor: ${money(totals.labor_cost_total, currency)} (${totals.labor_hours_estimate} hrs)`,
        `Total: ${money(totals.total_estimated_cost, currency)}`,
      ];
      chips.forEach(t => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = t;
        variantMeta.appendChild(chip);
      });

      // Update active carousel dot
      updateCarouselDots();
      preloadNeighborVariants(idx);
      updateAccessUI();
    }

    // Initialize carousel dots
    function initCarouselDots(){
      const dotsContainer = document.getElementById("carouselDots");
      dotsContainer.innerHTML = "";
      for (let i = 0; i < variants.length; i++) {
        const dot = document.createElement("div");
        dot.className = "dot";
        if (i === idx) dot.classList.add("active");
        dot.addEventListener("click", () => {
          setVariant(i);
        });
        dotsContainer.appendChild(dot);
      }
    }

    // Update which dot is active
    function updateCarouselDots(){
      const dots = document.querySelectorAll(".carousel-dots .dot");
      dots.forEach((dot, i) => {
        if (i === idx) {
          dot.classList.add("active");
        } else {
          dot.classList.remove("active");
        }
      });
    }

    function prev(){
      setVariant(idx - 1);
    }

    function next(){
      setVariant(idx + 1);
    }

    // Buttons
    prevBtn.addEventListener("click", prev);
    nextBtn.addEventListener("click", next);

    function handleLockedOverlayOpen(){
      if (!isLocked(idx)) return;
      openPaymentModal();
    }

    variantLockOverlay.addEventListener("click", handleLockedOverlayOpen);
    variantLockOverlay.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        handleLockedOverlayOpen();
      }
    });
    unlockVariantBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      handleLockedOverlayOpen();
    });

    // Keyboard arrows
    window.addEventListener("keydown", (e) => {
      if (document.getElementById("zoomOverlay")?.classList.contains("visible")) return;
      if (e.key === "ArrowLeft") prev();
      if (e.key === "ArrowRight") next();
    });

    // Swipe detection for carousel navigation
    let swipeStartX = 0;
    let swipeEndX = 0;
    let swipeStartY = 0;
    const swipeThreshold = 50; // minimum pixels for swipe detection
    
    const swipeTarget = variantFrame || compareCard;

    swipeTarget.addEventListener("touchstart", (e) => {
      swipeStartX = e.changedTouches[0].clientX;
      swipeStartY = e.changedTouches[0].clientY;
    }, false);

    swipeTarget.addEventListener("touchend", (e) => {
      swipeEndX = e.changedTouches[0].clientX;
      const swipeEndY = e.changedTouches[0].clientY;
      
      // Calculate distances
      const deltaX = swipeEndX - swipeStartX;
      const deltaY = swipeEndY - swipeStartY;
      
      // Only register swipe if horizontal movement is larger than vertical
      // and exceeds threshold
      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
        if (deltaX < 0) {
          // Swiped left - go to next
          next();
        } else {
          // Swiped right - go to previous
          prev();
        }
      }
    }, false);

    // Init
    buildGeneral();
    initCarouselDots();
    baseImg.src = baseImageUrl;
    setVariant(0);
    updateAccessUI();

    // --- index-based lock + PayPal payment ------------------------------------------------
    (function(){
      const paymentContainer = document.getElementById("paymentContainer");
      const paymentLayer = document.getElementById("paymentLayer");
      const unlockMessage = document.getElementById("unlockMessage");
      if (!paymentContainer || !paymentLayer) return;

      let paypalButtonsRendered = false;

      function hidePaymentModal(){
        paymentLayer.classList.remove("show");
      }

      function showPaymentModal(){
        paymentLayer.classList.add("show");
        requestAnimationFrame(() => {
          requestAnimationFrame(renderPayPalButtons);
        });
      }

      function onPaymentSuccess(){
        setPaidState(true);
        hidePaymentModal();
        unlockMessage.classList.add("show");
        setTimeout(() => unlockMessage.classList.remove("show"), 1400);
      }

      openPaymentModal = showPaymentModal;

      const renderPayPalButtons = () => {
        if (paypalButtonsRendered) return;

        if (!window.paypal) {
          setTimeout(renderPayPalButtons, 500);
          return;
        }

        const container = document.getElementById("paypal-button-container");
        if (!container) return;

        container.innerHTML = "";
        paypalButtonsRendered = true;
        container.style.pointerEvents = "auto";
        container.style.touchAction = "auto";
        container.style.cursor = "pointer";
        container.style.display = "block";
        container.style.width = "100%";
        container.style.maxWidth = "100%";
        container.style.minHeight = "50px";

        try {
          const isMobileDevice = window.innerWidth <= 600;
          const buttonHeight = isMobileDevice ? 55 : 50;

          paypal.Buttons({
            style: {
              layout: 'vertical',
              color: 'blue',
              shape: 'rect',
              label: 'paypal',
              height: buttonHeight,
              tagline: false
            },
            funding: {
              allowed: [paypal.FUNDING.PAYPAL],
              disallowed: [paypal.FUNDING.CARD]
            },
            createOrder: function(data, actions) {
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    value: "1.00",
                    currency_code: "USD"
                  }
                }]
              });
            },
            onApprove: function(data, actions) {
              return actions.order.capture().then(function(orderData) {
                onPaymentSuccess();
                console.log("Payment successful!", orderData);
              });
            },
            onError: function(err) {
              console.error("PayPal error", err);
              paypalButtonsRendered = false;
              alert("Payment error. Please try again.");
            }
          }).render("#paypal-button-container").then(function() {
            const paypalButtons = document.querySelectorAll('#paypal-button-container *');
            paypalButtons.forEach(btn => {
              btn.style.pointerEvents = "auto";
              btn.style.touchAction = "auto";
            });
          }).catch(function(err) {
            console.error("PayPal render error:", err);
            paypalButtonsRendered = false;
          });
        } catch (err) {
          console.error("PayPal setup error:", err);
          paypalButtonsRendered = false;
        }
      };

      const cancelBtn = document.getElementById("cancelPaymentBtn");
      if (cancelBtn) {
        cancelBtn.addEventListener("click", function() {
          hidePaymentModal();
          const container = document.getElementById("paypal-button-container");
          if (container) container.innerHTML = "";
          paypalButtonsRendered = false;
        });
      }
    })();

    // --- fullscreen zoomable image ---
    (function(){
      const zoomOverlay = document.getElementById('zoomOverlay');
      const zoomStage = document.getElementById('zoomStage');
      const zoomImg = document.getElementById('zoomImg');
      const zoomCloseBtn = document.getElementById('zoomCloseBtn');
      const zoomBtn = document.getElementById('zoomBtn');
      const zoomPrevBtn = document.getElementById('zoomPrevBtn');
      const zoomNextBtn = document.getElementById('zoomNextBtn');
      const PanzoomCtor = window.Panzoom;

      let panzoom = null;
      let wheelHandler = null;
      let lastTapTime = 0;
      let modalIndex = 0;

      function normalizeModalIndex(index){
        const count = variants.length;
        if (!count) return 0;
        return ((index % count) + count) % count;
      }

      function showModalImage(index){
        if (isLocked(index)) {
          closeZoom();
          openPaymentModal();
          return;
        }
        modalIndex = normalizeModalIndex(index);
        const src = variants[modalIndex]?.imageUrl || variantImg.src;
        zoomImg.dataset.modalIndex = String(modalIndex);
        zoomImg.onload = () => setupPanzoom();
        zoomImg.src = src;
        if (zoomImg.complete) setupPanzoom();
      }

      function prevModalImage(){
        showModalImage(modalIndex - 1);
      }

      function nextModalImage(){
        showModalImage(modalIndex + 1);
      }

      function removePanzoom(){
        if (panzoom && typeof panzoom.destroy === 'function') {
          panzoom.destroy();
        }
        panzoom = null;
        if (zoomStage && wheelHandler) {
          zoomStage.removeEventListener('wheel', wheelHandler);
        }
        wheelHandler = null;
        zoomImg.style.transform = '';
      }

      function setupPanzoom(){
        removePanzoom();
        if (!PanzoomCtor || !zoomStage) return;
        panzoom = PanzoomCtor(zoomImg, {
          maxScale: 5,
          minScale: 1,
          contain: 'inside',
          step: 0.25,
          startScale: 1,
          cursor: 'grab'
        });

        wheelHandler = (e) => {
          e.preventDefault();
          panzoom.zoomWithWheel(e);
        };
        zoomStage.addEventListener('wheel', wheelHandler, { passive: false });
      }

      function toggleDoubleTapZoom(clientX, clientY){
        if (!panzoom || !zoomStage) return;
        const rect = zoomStage.getBoundingClientRect();
        const focal = {
          x: clientX - rect.left,
          y: clientY - rect.top,
        };
        const nextScale = panzoom.getScale() > 1.15 ? 1 : 2.5;
        panzoom.zoom(nextScale, { animate: true, focal });
      }

      function openZoom(startIndex){
        zoomOverlay.classList.add('visible');
        zoomOverlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('zoom-lock');
        showModalImage(startIndex);
      }

      function closeZoom(){
        zoomOverlay.classList.remove('visible');
        zoomOverlay.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('zoom-lock');
        removePanzoom();
      }

      // expand button opens variant in zoom mode
      zoomBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (isLocked(idx)) {
          openPaymentModal();
          return;
        }
        openZoom(idx);
      });
      zoomPrevBtn.addEventListener('click', (e) => { e.stopPropagation(); prevModalImage(); });
      zoomNextBtn.addEventListener('click', (e) => { e.stopPropagation(); nextModalImage(); });

      // Only close on X button or Escape key - NOT on image click
      zoomCloseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeZoom(); });
      window.addEventListener('keydown', (e) => {
        if (!zoomOverlay.classList.contains('visible')) return;
        if (e.key === 'Escape') closeZoom();
        if (e.key === 'ArrowLeft') { e.preventDefault(); prevModalImage(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); nextModalImage(); }
      });

      // Image interactions for zoom/pan - prevent closing on click
      zoomImg.addEventListener('click', (e) => { e.stopPropagation(); });

      zoomStage.addEventListener('dblclick', (e) => {
        e.preventDefault();
        toggleDoubleTapZoom(e.clientX, e.clientY);
      });

      zoomStage.addEventListener('pointerup', (e) => {
        if (e.pointerType !== 'touch') return;
        const now = Date.now();
        if (now - lastTapTime < 280) {
          e.preventDefault();
          toggleDoubleTapZoom(e.clientX, e.clientY);
          lastTapTime = 0;
          return;
        }
        lastTapTime = now;
      });
    })();

    // --- image download functionality ---
    (function(){
      const zoomDownloadBtn = document.getElementById('zoomDownloadBtn');
      const zoomShareHint = document.getElementById('zoomShareHint');
      const downloadAllBtn = document.getElementById('downloadAllBtn');
      const defaultDownloadAllLabel = downloadAllBtn.textContent;

      function isMobile(){
        return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
          || (navigator.maxTouchPoints > 1 && window.matchMedia('(max-width: 1024px)').matches);
      }

      function canShareFiles(file){
        return !!(navigator.share && navigator.canShare && navigator.canShare({ files: [file] }));
      }

      function downloadImage(url, filename){
        const link = document.createElement('a');
        link.href = url;
        link.download = filename || 'image';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function setDownloadAllPreparing(isPreparing){
        downloadAllBtn.disabled = isPreparing;
        downloadAllBtn.setAttribute('aria-busy', String(isPreparing));
        if (isPreparing) {
          downloadAllBtn.textContent = 'Preparing‚Ä¶';
        } else {
          downloadAllBtn.textContent = isMobile() ? 'Share all' : defaultDownloadAllLabel;
        }
      }

      function legacyDownloadAll(){
        variants.forEach((v, i)=>{
          setTimeout(()=>{
            const filename = `variant-${i+1}-${v.label}-${new Date().toISOString().slice(0,10)}.jpg`;
            downloadImage(v.imageUrl, filename);
          }, i * 200);
        });
      }

      async function buildAllImagesZipBlob(){
        if (!window.JSZip) throw new Error('JSZip unavailable');
        const zip = new JSZip();

        const imageTasks = variants.map(async (v, index) => {
          const response = await fetch(v.imageUrl, { cache: 'no-store' });
          if (!response.ok) throw new Error(`Failed to fetch image: ${v.imageUrl}`);
          const blob = await response.blob();
          const type = blob.type || '';
          const ext = type.includes('png') ? 'png' : type.includes('webp') ? 'webp' : 'jpg';
          const fileName = `repaint-option-${String(index + 1).padStart(2, '0')}.${ext}`;
          zip.file(fileName, blob);
        });

        await Promise.all(imageTasks);
        return zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
      }

      async function shareOrDownloadAllImages(){
        if (!variants || variants.length === 0) return;

        if (!isMobile()) {
          legacyDownloadAll();
          return;
        }

        setDownloadAllPreparing(true);
        let zipBlob = null;

        try {
          zipBlob = await buildAllImagesZipBlob();
          const zipFile = new File([zipBlob], 'repaint-images.zip', { type: 'application/zip' });
          if (canShareFiles(zipFile)) {
            await navigator.share({
              files: [zipFile],
              title: 'Repaint images',
              text: 'All repaint options in one ZIP'
            });
            return;
          }
        } catch (error) {
          if (!zipBlob) {
            legacyDownloadAll();
            return;
          }
        } finally {
          setDownloadAllPreparing(false);
        }

        const zipUrl = URL.createObjectURL(zipBlob);
        downloadImage(zipUrl, 'repaint-images.zip');
        setTimeout(() => URL.revokeObjectURL(zipUrl), 1500);
      }

      async function shareOrDownloadCurrentModalImage(){
        const zoomImg = document.getElementById('zoomImg');
        const src = zoomImg?.src;
        if (!src) return;

        const currentIndex = Number(zoomImg.dataset.modalIndex || 0);
        const optionNumber = String(currentIndex + 1).padStart(2, '0');
        const srcPath = src.split('?')[0].toLowerCase();
        const inferredExt = srcPath.endsWith('.png') ? 'png' : 'jpg';
        let fileName = `repaint-option-${optionNumber}.${inferredExt}`;

        try {
          const response = await fetch(src, { cache: 'no-store' });
          if (!response.ok) throw new Error('Failed to fetch image');
          const blob = await response.blob();
          const type = blob.type || (inferredExt === 'png' ? 'image/png' : 'image/jpeg');
          const ext = type.includes('png') ? 'png' : 'jpg';
          fileName = `repaint-option-${optionNumber}.${ext}`;

          if (isMobile()) {
            const file = new File([blob], fileName, { type });
            if (canShareFiles(file)) {
              await navigator.share({
                files: [file],
                title: `Repaint Option ${optionNumber}`,
                text: 'Save Image to Photos'
              });
              return;
            }
          }

          const objectUrl = URL.createObjectURL(blob);
          downloadImage(objectUrl, fileName);
          setTimeout(() => URL.revokeObjectURL(objectUrl), 1500);
        } catch (error) {
          downloadImage(src, fileName);
        }
      }

      // download single image from zoom view
      zoomDownloadBtn.addEventListener('click', shareOrDownloadCurrentModalImage);

      if (isMobile()) {
        zoomDownloadBtn.textContent = 'Share / Save';
        if (zoomShareHint) {
          zoomShareHint.style.display = 'block';
        }
        downloadAllBtn.textContent = 'Share all';
      }

      // download/share all variant images
      downloadAllBtn.addEventListener('click', shareOrDownloadAllImages);
    })();
  </script>
</body>
</html>